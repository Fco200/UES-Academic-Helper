<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario Interactivo - UES</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <style>
        :root { --ues-guinda: #800000; }
        body { background-color: #f4f4f4; }
        #calendar { max-width: 900px; margin: 40px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .fc-toolbar-title { color: var(--ues-guinda); font-weight: bold; }
        .fc-button-primary { background-color: var(--ues-guinda) !important; border: none !important; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/home.html">⬅️ Volver al Inicio</a>
            <span class="navbar-text">Mi Agenda Académica</span>
        </div>
    </nav>
    <nav class="navbar navbar-dark bg-dark shadow">
    <div class="container">
        <a class="navbar-brand" href="/home.html">
            <i class="fas fa-arrow-left"></i> Volver al Menú Principal
        </a>
        <span class="badge bg-warning text-dark">Calendario Interactivo</span>
    </div>
</nav>

    <div class="container">
        <div id='calendar'></div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const userEmail = localStorage.getItem('userEmail');
            const calendarEl = document.getElementById('calendar');

            // 1. Obtener las tareas del servidor
            const response = await fetch(`/obtener-materias/${userEmail}`);
            const materias = await response.json();

            // 2. Transformar los datos de MongoDB al formato de FullCalendar
            const eventos = [];
            materias.forEach(materia => {
                materia.tareas.forEach(tarea => {
                    eventos.push({
                        title: `${materia.nombre}: ${tarea.descripcion}`,
                        start: tarea.fecha, // Formato YYYY-MM-DD
                        color: materia.nombre.toLowerCase().includes('personal') ? '#2c3e50' : '#800000'
                    });
                });
            });

            // 3. Inicializar el calendario
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                events: eventos, // Aquí se cargan tus tareas
                eventClick: function(info) {
                    alert('Tarea: ' + info.event.title);
                }
            });

            calendar.render();
        });
    </script>
</body>
</html>