<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | UES Helper</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --ues-guinda: #800000; 
            --ues-dark: #0f0f0f; 
            --ues-accent: #b8860b; 
            --glass-bg: rgba(255, 255, 255, 0.05);
            --sidebar-width: 280px;
        }

        body { 
            background: radial-gradient(circle at top right, #1a1a1a, #000); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: #e0e0e0; 
            min-height: 100vh;
        }

        /* Sidebar Pro */
        .sidebar { 
            background: rgba(10, 10, 10, 0.95); 
            backdrop-filter: blur(15px);
            color: white; 
            min-height: 100vh; 
            padding: 30px 20px; 
            position: fixed; 
            width: var(--sidebar-width); 
            border-right: 1px solid rgba(128, 0, 0, 0.3);
            z-index: 1000;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 40px;
            color: #fff;
            letter-spacing: -1px;
        }

        /* Banner IA Redise√±ado Estilo Cyber */
        .ai-banner { 
            background: linear-gradient(135deg, rgba(128, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.8) 100%); 
            color: white; 
            border-radius: 18px; 
            padding: 20px; 
            border: 1px solid var(--ues-guinda);
            box-shadow: 0 0 20px rgba(128, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .ai-banner::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(128,0,0,0.1) 0%, transparent 70%);
        }

        .main-content { 
            margin-left: var(--sidebar-width); 
            padding: 50px; 
            transition: all 0.3s;
        }

        /* Tarjetas Estilo Glassmorphism */
        .card-note { 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 24px; 
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-note:hover { 
            transform: translateY(-8px); 
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--ues-guinda);
        }

        .materia-header {
            padding: 22px;
            background: rgba(128, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            border-radius: 24px 24px 0 0;
        }

        /* Task styling */
        .task-row { 
            padding: 14px 18px; 
            border-radius: 12px;
            background: rgba(255,255,255,0.02);
            margin-bottom: 8px;
            border: 1px solid transparent;
        }
        
        .task-row:hover { 
            background: rgba(255,255,255,0.05);
            border-color: rgba(128,0,0,0.3);
        }

        .form-check-input {
            background-color: #1a1a1a;
            border: 1px solid #444;
        }

        .form-check-input:checked { 
            background-color: var(--ues-guinda); 
            border-color: var(--ues-accent); 
        }

        /* Botones y Form */
        .btn-ues { 
            background: var(--ues-guinda); 
            border: none;
            color: white; 
            border-radius: 12px; 
            font-weight: 700;
            transition: 0.3s;
        }

        .btn-ues:hover {
            background: #a00000;
            box-shadow: 0 0 15px rgba(128,0,0,0.4);
        }

        .form-control { 
            background: rgba(255,255,255,0.05) !important;
            border: 1px solid rgba(255,255,255,0.1);
            color: white !important;
            border-radius: 12px;
            padding: 12px 18px;
        }

        .form-control:focus { 
            background: rgba(255,255,255,0.08) !important;
            border-color: var(--ues-guinda);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.2);
        }

        .badge-profile {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 24px;
            border-radius: 100px;
        }

        @media (max-width: 992px) {
            .sidebar { width: 100%; min-height: auto; position: relative; border-right: none; border-bottom: 1px solid var(--ues-guinda); }
            .main-content { margin-left: 0; padding: 25px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand">
            UES <span class="text-danger">HELPER</span>
        </div>
        
        <div class="ai-banner mb-4">
            <div class="d-flex align-items-center mb-2">
                <i class="fas fa-robot text-danger me-2 shadow-sm"></i>
                <span class="fw-bold small text-uppercase" style="letter-spacing: 1px;">Estado de IA</span>
            </div>
            <p id="ai-text" class="small mt-2 mb-0 opacity-75 fw-light">Analizando tu desempe√±o acad√©mico...</p>
        </div>

        <hr class="opacity-10 my-4">

        <nav class="nav flex-column">
            <a href="/home.html" class="nav-link text-white py-3 px-3 rounded-4 mb-2 d-flex align-items-center" style="background: rgba(255,255,255,0.03);">
                <i class="fas fa-home me-3 text-danger"></i> Inicio
            </a>
            <button class="nav-link text-white py-3 px-3 rounded-4 mb-2 border-0 text-start bg-transparent d-flex align-items-center" onclick="cambiarPassword()">
                <i class="fas fa-shield-alt me-3 text-warning"></i> Seguridad
            </button>
        </nav>

        <button class="btn btn-ues w-100 mt-5 py-3 shadow" onclick="cerrarSesion()">
            <i class="fas fa-power-off me-2"></i> Salir del Sistema
        </button>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5 flex-wrap gap-3">
            <div>
                <h1 class="fw-bold m-0" style="letter-spacing: -1.5px;">Gesti√≥n de Actividades</h1>
                <p class="text-muted m-0">Consola central de registros e ingenier√≠a de tareas.</p>
            </div>
            <div class="badge-profile d-flex align-items-center">
                <div class="text-end me-3">
                    <span id="carreraBadge" class="d-block fw-bold text-warning small text-uppercase"></span>
                    <span id="userBadge" class="small opacity-50"></span>
                </div>
                <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                    <i class="fas fa-user-graduate text-white"></i>
                </div>
            </div>
        </div>

        <div class="card p-4 card-note mb-5 border-0" style="background: linear-gradient(rgba(128,0,0,0.05), rgba(0,0,0,0.2));">
            <h5 class="fw-bold mb-4 d-flex align-items-center">
                <i class="fas fa-plus-square text-danger me-3"></i> 
                A√±adir Materia o Proyecto
            </h5>
            <div class="row g-3">
                <div class="col-md-9">
                    <input type="text" id="nombreInput" class="form-control" placeholder="Nombre de la asignatura (Ej: Programaci√≥n IV)">
                </div>
                <div class="col-md-3">
                    <button onclick="guardarNuevo()" class="btn btn-ues w-100 py-2">
                        <i class="fas fa-save me-2"></i> Guardar
                    </button>
                </div>
            </div>
        </div>

        <div id="contenedorPrincipal" class="row">
            </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="background: #1a1a1a; border-radius: 28px; border: 1px solid #333 !important;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-danger px-3 pt-3">Ajustes de Actividad</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted mb-2">DESCRIPCI√ìN</label>
                        <input type="text" id="editDescripcion" class="form-control">
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted mb-2">FECHA DE ENTREGA</label>
                        <input type="date" id="editFecha" class="form-control">
                    </div>
                    
                    <div class="form-check form-switch p-3 rounded-4 bg-dark">
                        <input class="form-check-input ms-0 me-3" type="checkbox" id="editCompletada">
                        <label class="form-check-label small fw-bold text-white" for="editCompletada">Marcar como finalizada</label>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button class="btn btn-dark px-4 py-2 rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-ues px-5 py-2 rounded-pill" id="saveEditBtn">Actualizar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mantenemos EXACTAMENTE tus funciones de l√≥gica
        const userEmail = localStorage.getItem('userEmail');
        const userCarrera = localStorage.getItem('userCarrera');
        
        document.getElementById('userBadge').innerText = userEmail || 'Invitado';
        document.getElementById('carreraBadge').innerText = userCarrera || 'UES ESTUDIANTE';
        
        let editMateriaId = null, editTareaId = null;

        async function cargarTodo() {
            if (!userEmail) return window.location.href = '/index.html';
            try {
                const res = await fetch(`/obtener-materias/${encodeURIComponent(userEmail)}`);
                const materias = await res.json();
                const cont = document.getElementById('contenedorPrincipal');
                cont.innerHTML = '';

                materias.forEach(m => {
                    const tareasHtml = (m.tareas || []).map(t => `
                        <div class="task-row d-flex align-items-center">
                            <input type="checkbox" class="form-check-input me-3" 
                                ${t.completada ? 'checked' : ''} 
                                onclick="toggleTarea('${m._id}', '${t._id}', ${t.completada})">
                            <span class="${t.completada ? 'text-decoration-line-through opacity-40' : ''} flex-grow-1">
                                ${escapeHtml(t.descripcion)}
                            </span>
                            <span class="badge bg-dark border border-secondary text-muted mx-2" style="font-size: 0.75em;">${t.fecha || ''}</span>
                            <button class="btn btn-sm btn-link text-danger p-0 ms-2" 
                                onclick="abrirEditor('${m._id}', '${t._id}', ${JSON.stringify(t.descripcion || '')}, ${JSON.stringify(t.fecha || '')}, ${t.completada})">
                                <i class="fas fa-sliders-h"></i>
                            </button>
                        </div>
                    `).join('') || '<p class="text-muted small text-center my-3 fw-light">Bandeja de entrada vac√≠a</p>';

                    cont.innerHTML += `
                        <div class="col-lg-6 mb-4">
                            <div class="card card-note h-100">
                                <div class="materia-header d-flex justify-content-between align-items-center">
                                    <h5 class="fw-bold m-0 text-white" style="font-size: 1rem;">
                                        <i class="fas fa-folder-open me-2 text-danger opacity-50"></i>
                                        ${escapeHtml(m.nombre)}
                                    </h5>
                                    <button onclick="pedirIA('${escapeJs(m.nombre)}')" class="btn btn-sm btn-outline-warning border-0 p-0 px-2" style="font-size: 0.7rem;">
                                        <i class="fas fa-magic"></i> TIPS
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="tareas-container mb-4">${tareasHtml}</div>
                                    <div class="input-group input-group-sm">
                                        <input type="text" id="t-${m._id}" class="form-control" placeholder="Nueva tarea...">
                                        <input type="date" id="f-${m._id}" class="form-control">
                                        <button onclick="agregarTarea('${m._id}')" class="btn btn-ues"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        // --- TODAS TUS FUNCIONES ORIGINALES SIGUEN AQU√ç ---

        async function guardarNuevo() {
            const nombre = document.getElementById('nombreInput').value.trim();
            if (!nombre) return;
            await fetch('/agregar-materia', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, nombre }) });
            document.getElementById('nombreInput').value = '';
            cargarTodo();
        }

        async function agregarTarea(idMateria) {
            const descripcion = document.getElementById(`t-${idMateria}`).value.trim();
            const fecha = document.getElementById(`f-${idMateria}`).value;
            if (!descripcion) return;
            await fetch('/agregar-tarea', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ materiaId: idMateria, descripcion, fecha }) });
            document.getElementById(`t-${idMateria}`).value = '';
            cargarTodo();
        }

        async function pedirIA(materia) {
            const res = await fetch('/ia-asistente', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: `Dame un consejo corto para: ${materia}` }) });
            const data = await res.json();
            alert("Consejo IA: " + data.respuesta);
        }

        async function toggleTarea(mId, tId, est) {
            await fetch('/completar-tarea', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ materiaId: mId, tareaId: tId, completada: !est }) });
            cargarTodo();
        }

        function abrirEditor(mId, tId, desc, fecha, comp) {
            editMateriaId = mId; editTareaId = tId;
            document.getElementById('editDescripcion').value = desc;
            document.getElementById('editFecha').value = fecha;
            document.getElementById('editCompletada').checked = comp;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const nuevaDescripcion = document.getElementById('editDescripcion').value.trim();
            const nuevaFecha = document.getElementById('editFecha').value;
            const completada = document.getElementById('editCompletada').checked;
            
            await fetch('/editar-tarea', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ materiaId: editMateriaId, tareaId: editTareaId, nuevaDescripcion, nuevaFecha }) });
            await fetch('/completar-tarea', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ materiaId: editMateriaId, tareaId: editTareaId, completada }) });
            
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            cargarTodo();
        });

        window.onload = function() {
            cargarTodo();
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fuerzaCambio') === 'true') {
                alert("üö® SEGURIDAD UES: Detectamos que usas la contrase√±a inicial. Por favor, c√°mbiala ahora para proteger tu cuenta.");
                cambiarPassword(); 
            }
        };

        async function cambiarPassword() {
            const nueva = prompt("Ingresa tu nueva contrase√±a personalizada (M√≠nimo 6 caracteres):");
            if (!nueva || nueva === "UES2026") {
                alert("üö® ERROR: Debes elegir una clave segura y diferente a la temporal.");
                return;
            }
            try {
                const res = await fetch('/cambiar-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, nuevaPassword: nueva })
                });
                if (res.ok) {
                    alert("‚úÖ CONTRASE√ëA ACTUALIZADA CON √âXITO.\n\nRecuerda: La clave temporal 'UES2026' ya no funcionar√°. El sistema se cerrar√°.");
                    localStorage.clear();
                    window.location.href = '/index.html'; 
                }
            } catch (e) { console.error(e); }
        }

        function cerrarSesion() { localStorage.clear(); window.location.href = '/index.html'; }
        function escapeHtml(str) { return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;'); }
        function escapeJs(str) { return String(str).replaceAll("'", "\\'"); }
    </script>
</body>
</html>