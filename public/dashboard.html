<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Control | UES Helper</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    <style>
        :root { --ues: #800000; --dark: #1a1a1a; }
        body { background: #f8f9fa; font-family: 'Inter', sans-serif; }
        .sidebar { background: var(--dark); color: white; min-height: 100vh; padding: 25px; position: fixed; width: 250px; }
        .main-content { margin-left: 250px; padding: 40px; }
        .card-note { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .ai-banner { background: linear-gradient(45deg, var(--ues), #4b0000); color: white; border-radius: 12px; padding: 20px; border-left: 5px solid #b8860b; }
        .btn-ues { background: var(--ues); color: white; }
        .small-muted { font-size: 0.85rem; color: #6c757d; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="fw-bold mb-4">UES <span class="text-danger">Helper</span></h3>
        <div class="ai-banner mb-4">
            <small class="fw-bold"><i class="fas fa-robot"></i> ASISTENTE IA</small>
            <p id="ai-text" class="small mt-2 mb-0">Analizando tus pendientes...</p>
        </div>
        <hr>
        <button class="btn btn-outline-light w-100 mb-2 btn-sm" onclick="cambiarPassword()">Seguridad</button>
        <a href="/home.html" class="btn btn-outline-secondary w-100 mb-2 btn-sm">Regresar al Inicio</a>
        <button class="btn btn-danger w-100 btn-sm mt-5" onclick="cerrarSesion()">Cerrar Sesi贸n</button>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h2 class="fw-bold">Gesti贸n de Actividades</h2>
            <div class="badge bg-dark p-2" id="userBadge">Cargando...</div>
        </div>

        <div class="card p-4 card-note bg-white mb-5">
            <h5 class="fw-bold text-danger mb-3">Nuevo Registro</h5>
            <div class="input-group">
                <input type="text" id="nombreInput" class="form-control" placeholder="Materia o Nota Personal">
                <button onclick="guardarNuevo()" class="btn btn-dark px-4">Guardar</button>
            </div>
        </div>

        <div id="contenedorPrincipal" class="row"></div>
    </div>

    <!-- Modal de edici贸n -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar tarea</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label class="form-label small-muted">Descripci贸n</label>
            <input type="text" id="editDesc" class="form-control mb-2" placeholder="Descripci贸n">
            <label class="form-label small-muted">Fecha</label>
            <input type="date" id="editFecha" class="form-control">
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" id="editCompletada">
              <label class="form-check-label small-muted" for="editCompletada">Marcar como completada</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-primary" id="saveEditBtn">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        const userEmail = localStorage.getItem('userEmail');
        document.getElementById('userBadge').innerText = userEmail || 'Invitado';

        // Variables para edici贸n
        let editMateriaId = null, editTareaId = null;

        // Cargar materias y tareas
        async function cargarTodo() {
            if (!userEmail) return window.location.href = '/index.html';
            try {
                const res = await fetch(`/obtener-materias/${encodeURIComponent(userEmail)}`);
                const materias = await res.json();
                const cont = document.getElementById('contenedorPrincipal');
                cont.innerHTML = '';

                materias.forEach(m => {
                    const tareasHtml = (m.tareas || []).map(t => {
                        // Usamos JSON.stringify para escapar correctamente las cadenas en el onclick
                        return `
                            <div class="d-flex align-items-center border-bottom py-2">
                                <input type="checkbox" class="form-check-input me-2" 
                                    ${t.completada ? 'checked' : ''} 
                                    onclick="toggleTarea('${m._id}', '${t._id}', ${t.completada})">
                                <span class="${t.completada ? 'text-decoration-line-through text-muted' : ''} flex-grow-1 small">
                                    ${escapeHtml(t.descripcion)}
                                </span>
                                <span class="badge bg-light text-dark ms-2" style="font-size: 0.7em;">${t.fecha || ''}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" 
                                    onclick="abrirEditor('${m._id}', '${t._id}', ${JSON.stringify(t.descripcion || '')}, ${JSON.stringify(t.fecha || '')}, ${t.completada})">
                                    锔
                                </button>
                            </div>
                        `;
                    }).join('') || '<p class="text-muted small">Sin registros</p>';

                    cont.innerHTML += `
                        <div class="col-md-6 mb-4">
                            <div class="card p-4 card-note bg-white">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="fw-bold m-0 ${m.nombre.toLowerCase().includes('nota') ? 'text-primary' : 'text-dark'}">${escapeHtml(m.nombre)}</h4>
                                    <button onclick="pedirIA('${escapeJs(m.nombre)}')" class="btn btn-sm btn-outline-danger"> IA</button>
                                </div>
                                <div class="tareas-container">
                                    ${tareasHtml}
                                </div>
                                <div class="input-group input-group-sm mt-3">
                                    <input type="text" id="t-${m._id}" class="form-control" placeholder="Tarea o detalle...">
                                    <input type="date" id="f-${m._id}" class="form-control">
                                    <button onclick="agregarTarea('${m._id}')" class="btn btn-ues">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                console.error(e);
                alert('Error cargando datos.');
            }
        }

        // Guardar nueva materia
        async function guardarNuevo() {
            const nombre = document.getElementById('nombreInput').value.trim();
            if (!nombre) return alert('Ingresa un nombre.');
            await fetch('/agregar-materia', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, nombre }) });
            document.getElementById('nombreInput').value = '';
            cargarTodo();
        }

        // Agregar tarea
        async function agregarTarea(idMateria) {
            const descripcion = document.getElementById(`t-${idMateria}`).value.trim();
            const fecha = document.getElementById(`f-${idMateria}`).value;
            if (!descripcion) return alert('Describe la tarea.');
            await fetch('/agregar-tarea', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ materiaId: idMateria, descripcion, fecha }) });
            document.getElementById(`t-${idMateria}`).value = '';
            document.getElementById(`f-${idMateria}`).value = '';
            cargarTodo();
        }

        // Cambiar contrase帽a
        async function cambiarPassword() {
            const nueva = prompt("Ingresa tu nueva contrase帽a:");
            if (nueva) {
                await fetch('/cambiar-password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, nuevaPassword: nueva }) });
                alert("Contrase帽a actualizada con 茅xito.");
            }
        }

        // Pedir consejo IA
        async function pedirIA(materia) {
            try {
                const res = await fetch('/ia-asistente', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: `Dame un consejo corto para estudiar la materia: ${materia}` }) });
                const data = await res.json();
                alert("Consejo IA: " + (data.respuesta || 'Sin respuesta'));
            } catch (e) {
                alert('Error con IA.');
            }
        }

        // Marcar completada / pendiente
        async function toggleTarea(materiaId, tareaId, estadoActual) {
            await fetch('/completar-tarea', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ materiaId, tareaId, completada: !estadoActual })
            });
            cargarTodo();
        }

        // Abrir editor modal
        function abrirEditor(materiaId, tareaId, desc, fecha, completada) {
            editMateriaId = materiaId;
            editTareaId = tareaId;
            document.getElementById('editDesc').value = desc || '';
            document.getElementById('editFecha').value = fecha || '';
            document.getElementById('editCompletada').checked = !!completada;
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        // Guardar edici贸n
        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const nuevaDescripcion = document.getElementById('editDesc').value.trim();
            const nuevaFecha = document.getElementById('editFecha').value;
            const completada = document.getElementById('editCompletada').checked;
            if (!nuevaDescripcion) return alert('La descripci贸n no puede quedar vac铆a.');
            await fetch('/editar-tarea', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ materiaId: editMateriaId, tareaId: editTareaId, nuevaDescripcion, nuevaFecha })
            });
            // Actualizar estado completada si cambi贸
            await fetch('/completar-tarea', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ materiaId: editMateriaId, tareaId: editTareaId, completada })
            });
            cargarTodo();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        });

        function cerrarSesion() { localStorage.clear(); window.location.href = '/index.html'; }

        // Helpers para evitar inyecci贸n en HTML
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
        function escapeJs(str) {
            if (!str) return '';
            return String(str).replaceAll("'", "\\'");
        }

        window.onload = cargarTodo;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
