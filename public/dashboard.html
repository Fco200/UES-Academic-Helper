<div class="container mt-3 text-end">
    <button class="btn btn-outline-dark btn-sm" onclick="cambiarMiPassword()">Cambiar Contraseña</button>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5 id="labelAgregar">Agregar Materia</h5>
                <input type="text" id="nombreMateria" class="form-control mb-2" placeholder="...">
                <button onclick="guardarMateria()" class="btn btn-success w-100">Guardar</button>
            </div>
        </div>
        <div class="col-md-8">
            <h3 id="labelLista">Mis Registros</h3>
            <div id="listaMaterias"></div>
        </div>
    </div>
</div>

<script>
    // Lógica para adaptar el texto según perfil
    const tipoRegistro = localStorage.getItem('tipoRegistro'); // "Estudio", "Trabajo" o "Notas"
    document.getElementById('labelAgregar').innerText = `Agregar ${tipoRegistro === 'Notas' ? 'Categoría de Nota' : 'Materia'}`;
    document.getElementById('labelLista').innerText = `Mis ${tipoRegistro === 'Notas' ? 'Notas' : 'Materias'}`;

    async function cargarMaterias() {
        const res = await fetch(`/obtener-materias/${userEmail}`);
        const materias = await res.json();
        const div = document.getElementById('listaMaterias');
        div.innerHTML = '';

        materias.forEach(m => {
            // Filtrar solo tareas NO completadas
            let tareasHTML = m.tareas.filter(t => !t.completada).map(t => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-thumbtack text-warning me-2"></i> ${t.descripcion} 
                        <span class="badge bg-info ms-2">${t.fecha}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="completarTarea('${m._id}', '${t._id}')">
                        <i class="fas fa-check"></i> Listo
                    </button>
                </li>
            `).join('');

            div.innerHTML += `
                <div class="card p-3 card-materia shadow-sm">
                    <h4><i class="fas fa-folder-open me-2"></i>${m.nombre}</h4>
                    <ul class="list-group list-group-flush mb-3">${tareasHTML || '<p class="text-muted">Todo al día</p>'}</ul>
                    <div class="input-group">
                        <input type="text" id="desc-${m._id}" class="form-control" placeholder="Nueva anotación...">
                        <input type="date" id="fecha-${m._id}" class="form-control">
                        <button onclick="agregarTarea('${m._id}')" class="btn btn-guinda">Añadir</button>
                    </div>
                </div>`;
        });
    }

    async function completarTarea(mId, tId) {
        await fetch('/completar-tarea', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ materiaId: mId, tareaId: tId })
        });
        cargarMaterias();
    }

    async function cambiarMiPassword() {
        const nueva = prompt("Ingresa tu nueva contraseña:");
        if(!nueva) return;
        await fetch('/cambiar-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: userEmail, nuevaPassword: nueva })
        });
        alert("Contraseña actualizada. Úsala en tu próximo inicio de sesión.");
    }

    // Al cargar la página, ejecutar cargarMaterias()
    cargarMaterias();
</script>