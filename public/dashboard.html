<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | UES Helper</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    <style>
        :root { --ues-guinda: #800000; --ues-dark: #0f0f0f; --sidebar-w: 280px; }
        body { background: #000; color: #e0e0e0; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; }
        
        /* Sidebar Interactivo */
        .sidebar { width: var(--sidebar-w); background: rgba(15,15,15,0.98); border-right: 1px solid rgba(128,0,0,0.3); height: 100vh; position: fixed; padding: 30px 20px; z-index: 1000; }
        .sidebar-brand { font-size: 1.5rem; font-weight: 800; text-align: center; margin-bottom: 40px; color: #fff; letter-spacing: -1px; }
        
        .main-content { margin-left: var(--sidebar-w); padding: 50px; transition: 0.3s; }
        
        /* Botones de NavegaciÃ³n Lateral */
        .nav-btn { width: 100%; padding: 15px 20px; border-radius: 15px; display: flex; align-items: center; color: #888; text-decoration: none; transition: 0.4s; margin-bottom: 10px; border: 1px solid transparent; background: transparent; }
        .nav-btn:hover { background: rgba(128,0,0,0.15); color: white; transform: translateX(8px); border-color: var(--ues-guinda); }
        .nav-btn.active { background: var(--ues-guinda); color: white; box-shadow: 0 4px 15px rgba(128,0,0,0.3); }

        /* Banner IA */
        .ai-banner { background: linear-gradient(135deg, rgba(128, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.8) 100%); border-radius: 18px; padding: 20px; border: 1px solid var(--ues-guinda); margin-bottom: 30px; }

        /* EstÃ©tica de Tarjetas */
        .card-note { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; backdrop-filter: blur(10px); transition: 0.4s; overflow: hidden; }
        .card-note:hover { border-color: var(--ues-guinda); transform: translateY(-5px); }
        .materia-header { padding: 20px; background: rgba(128, 0, 0, 0.1); border-bottom: 1px solid rgba(255,255,255,0.05); }

        .btn-ues { background: var(--ues-guinda); color: white; border: none; border-radius: 12px; font-weight: 700; padding: 10px 20px; transition: 0.3s; }
        .form-control { background: rgba(255,255,255,0.05) !important; border: 1px solid rgba(255,255,255,0.1); color: white !important; border-radius: 12px; }
        
        .task-row { padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.02); margin-bottom: 8px; border: 1px solid transparent; }
        .task-row:hover { background: rgba(255,255,255,0.05); border-color: rgba(128,0,0,0.2); }

        @media (max-width: 992px) { .sidebar { width: 100%; height: auto; position: relative; } .main-content { margin-left: 0; padding: 25px; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-brand">UES <span class="text-danger">HELPER</span></div>
        <div class="ai-banner">
            <small class="fw-bold text-uppercase text-danger"><i class="fas fa-robot me-2"></i> IA Status</small>
            <p id="ai-text" class="small mt-2 mb-0 opacity-75 fw-light">Sincronizando tus metas acadÃ©micas...</p>
        </div>
       <div class="d-flex justify-content-between align-items-center mb-4 bg-dark p-3 rounded-4 border-bottom border-danger">
    <div class="d-flex align-items-center">
        <a href="/home.html" class="btn btn-danger rounded-pill px-4 me-3 fw-bold shadow">
            <i class="fas fa-home me-2"></i> INICIO
        </a>
        <h5 class="m-0 text-white-50 small fw-bold">PORTAL ACADÃ‰MICO</h5>
    </div>
    <div id="reloj" class="text-danger fw-bold small"></div>
</div>
   
            
            <a href="/dashboard.html" class="nav-link-custom"><i class="fas fa-tasks me-2"></i> Tareas</a>
            <a href="/perfil.html" class="nav-link-custom"><i class="fas fa-user-circle me-2"></i> Mi Perfil</a>
            <a href="/seguridad.html" class="nav-link-custom"><i class="fas fa-shield-alt me-2 text-danger"></i> Seguridad</a>
            <a href="/soporte.html" class="nav-link-custom active"><i class="fas fa-headset me-2"></i> Soporte / OpiniÃ³n</a>
     
    
    <button onclick="cambiarPassword()" class="nav-btn bg-transparent border-0">
        <i class="fas fa-shield-alt me-3 text-warning"></i> Seguridad
    </button>
</nav>
        <button onclick="cerrarSesion()" class="btn btn-danger w-100 rounded-pill py-3 mt-5 shadow"><i class="fas fa-power-off me-2"></i> SALIR</button>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5 flex-wrap">
            <div>
                <h1 class="fw-bold m-0" style="letter-spacing: -1px;">GestiÃ³n de Actividades</h1>
                <p class="text-muted m-0 small">Consola de registros e ingenierÃ­a de tareas.</p>
            </div>
            <div class="bg-dark p-3 rounded-pill border border-secondary shadow-sm d-flex align-items-center">
                <div class="text-end me-3">
                    <span id="carreraBadge" class="d-block fw-bold text-warning small"></span>
                    <span id="userBadge" class="small opacity-50"></span>
                </div>
                <i class="fas fa-user-graduate fa-2x text-danger"></i>
            </div>
        </div>

        <div class="card p-4 card-note mb-5 border-0 shadow-lg">
            <h5 class="fw-bold text-danger mb-4"><i class="fas fa-plus-circle me-2"></i> AÃ±adir Nuevo Registro</h5>
            <div class="row g-3">
                <div class="col-md-9"><input type="text" id="nombreInput" class="form-control" placeholder="Nombre de asignatura..."></div>
                <div class="col-md-3"><button onclick="guardarNuevo()" class="btn btn-ues w-100 py-2">Guardar</button></div>
            </div>
        </div>
        <div id="contenedorPrincipal" class="row"></div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg bg-dark p-3" style="border-radius: 28px;">
                <h5 class="modal-title fw-bold text-danger mb-3 px-3 pt-3">Ajustar Actividad</h5>
                <div class="modal-body p-4">
                    <label class="form-label small fw-bold text-muted">DESCRIPCIÃ“N</label>
                    <input type="text" id="editDescripcion" class="form-control mb-4">
                    <label class="form-label small fw-bold text-muted">FECHA ENTREGA</label>
                    <input type="date" id="editFecha" class="form-control mb-4">
                    <div class="form-check form-switch bg-black p-3 rounded-3">
                        <input class="form-check-input ms-0 me-3" type="checkbox" id="editCompletada">
                        <label class="form-check-label small fw-bold text-white" for="editCompletada">Â¿Completada?</label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-dark rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                    <button class="btn btn-ues rounded-pill px-4" id="saveEditBtn">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const userEmail = localStorage.getItem('userEmail'), userCarrera = localStorage.getItem('userCarrera');
        document.getElementById('userBadge').innerText = userEmail || 'Invitado';
        document.getElementById('carreraBadge').innerText = userCarrera || 'SOFTWARE';
        let editMateriaId = null, editTareaId = null;

        async function cargarTodo() {
            if (!userEmail) return window.location.href = '/index.html';
            const res = await fetch(`/obtener-materias/${encodeURIComponent(userEmail)}`);
            const materias = await res.json();
            const cont = document.getElementById('contenedorPrincipal');
            cont.innerHTML = '';
            materias.forEach(m => {
                const tareasHtml = (m.tareas || []).map(t => `
                    <div class="task-row d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-3" ${t.completada ? 'checked' : ''} onclick="toggleTarea('${m._id}', '${t._id}', ${t.completada})">
                        <span class="${t.completada ? 'text-decoration-line-through opacity-40' : ''} flex-grow-1 small">${escapeHtml(t.descripcion)}</span>
                        <span class="badge bg-dark border border-secondary text-muted mx-2">${t.fecha || ''}</span>
                        <button class="btn btn-sm text-danger p-0 ms-2" onclick="abrirEditor('${m._id}', '${t._id}', ${JSON.stringify(t.descripcion)}, ${JSON.stringify(t.fecha)}, ${t.completada})"><i class="fas fa-edit"></i></button>
                    </div>
                `).join('') || '<p class="text-muted small text-center my-3">Sin tareas</p>';
                cont.innerHTML += `<div class="col-lg-6 mb-4"><div class="card card-note h-100"><div class="materia-header d-flex justify-content-between align-items-center"><h6 class="fw-bold m-0 text-white"><i class="fas fa-folder me-2 text-danger"></i>${escapeHtml(m.nombre)}</h6><button onclick="pedirIA('${escapeJs(m.nombre)}')" class="btn btn-sm btn-outline-warning border-0 p-0 px-2 small">IA TIPS</button></div><div class="card-body"><div class="tareas-container mb-4">${tareasHtml}</div><div class="input-group input-group-sm"><input type="text" id="t-${m._id}" class="form-control" placeholder="Nueva..."><input type="date" id="f-${m._id}" class="form-control"><button onclick="agregarTarea('${m._id}')" class="btn btn-ues"><i class="fas fa-plus"></i></button></div></div></div></div>`;
            });
        }
        async function guardarNuevo(){ const n=document.getElementById('nombreInput').value.trim(); if(n){await fetch('/agregar-materia',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:userEmail,nombre:n})}); document.getElementById('nombreInput').value=''; cargarTodo();}}
        async function agregarTarea(id){ const d=document.getElementById(`t-${id}`).value.trim(), f=document.getElementById(`f-${id}`).value; if(d){await fetch('/agregar-tarea',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({materiaId:id,descripcion:d,fecha:f})}); cargarTodo();}}
        async function pedirIA(m){ const res=await fetch('/ia-asistente',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:`Dame un consejo corto para: ${m}`})}); const d=await res.json(); alert("IA: "+d.respuesta);}
        async function toggleTarea(m,t,e){ await fetch('/completar-tarea',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({materiaId:m,tareaId:t,completada:!e})}); cargarTodo();}
        function abrirEditor(m,t,d,f,c){ editMateriaId=m; editTareaId=t; document.getElementById('editDescripcion').value=d; document.getElementById('editFecha').value=f; document.getElementById('editCompletada').checked=c; new bootstrap.Modal(document.getElementById('editModal')).show();}
        document.getElementById('saveEditBtn').addEventListener('click', async()=>{ const d=document.getElementById('editDescripcion').value.trim(), f=document.getElementById('editFecha').value, c=document.getElementById('editCompletada').checked; await fetch('/editar-tarea',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({materiaId:editMateriaId,tareaId:editTareaId,nuevaDescripcion:d,nuevaFecha:f})}); await fetch('/completar-tarea',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({materiaId:editMateriaId,tareaId:editTareaId,completada:c})}); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); cargarTodo();});
        async function cambiarPassword(){ const n=prompt("Nueva contraseÃ±a:"); if(n && n!=="UES2026"){ await fetch('/cambiar-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:userEmail,nuevaPassword:n})}); alert("Ã‰xito. La clave 'UES2026' ya no funciona."); localStorage.clear(); window.location.href='/index.html'; }}
        function cerrarSesion(){ localStorage.clear(); window.location.href='/index.html'; }
        function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
        function escapeJs(s){ return String(s).replaceAll("'","\\'"); }
        window.onload = function(){ cargarTodo(); if(new URLSearchParams(window.location.search).get('fuerzaCambio')==='true'){ alert("ðŸš¨ Seguridad UES: Cambia tu clave ahora."); cambiarPassword(); }};
        // Seguridad: Si no hay un correo en el localStorage, regresa al inicio
if (!localStorage.getItem('userEmail')) {
    window.location.href = '/bienvenida.html';
}
    </script>
</body>
</html>