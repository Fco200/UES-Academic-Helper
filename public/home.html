<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | UES Academic Helper</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <style>
        :root { --ues-guinda: #800000; --ues-oro: #b8860b; --dark-bg: #121212; --glass: rgba(30, 30, 30, 0.95); }
        
        body { 
            background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=2070&auto=format&fit=crop');
            background-size: cover; background-attachment: fixed;
            font-family: 'Inter', sans-serif; color: white; overflow-x: hidden;
        }

        /* Sidebar con Foto de Perfil */
        .sidebar { 
            background: var(--dark-bg); color: white; min-height: 100vh; position: fixed; 
            width: 280px; padding: 30px; z-index: 1000; border-right: 1px solid var(--ues-guinda);
            backdrop-filter: blur(10px);
        }

        .profile-area { text-align: center; margin-bottom: 30px; }
        .profile-pic {
            width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--ues-guinda);
            object-fit: cover; cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px rgba(128, 0, 0, 0.5);
        }
        .profile-pic:hover { transform: scale(1.05); border-color: var(--ues-oro); }

        .main-content { margin-left: 280px; padding: 40px; }

        .nav-link-custom { 
            color: #adb5bd; padding: 12px 15px; border-radius: 12px; 
            margin-bottom: 8px; display: block; text-decoration: none; transition: 0.3s; 
        }
        .nav-link-custom:hover, .nav-link-custom.active { background: var(--ues-guinda); color: white; }

        /* Cards Glassmorphism */
        .glass-card { 
            background: var(--glass); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); 
            padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .header-status { 
            background: linear-gradient(135deg, var(--ues-guinda), #4a0000); 
            color: white; border-radius: 20px; padding: 30px; margin-bottom: 40px; 
            border-left: 5px solid var(--ues-oro);
        }

        #calendar { background: white; color: black; padding: 15px; border-radius: 15px; }
        .reloj-box { font-family: 'Monaco', monospace; font-weight: bold; font-size: 1.8rem; color: var(--ues-oro); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="profile-area">
            <img src="https://via.placeholder.com/110" id="userPhoto" class="profile-pic" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" style="display:none" onchange="subirFoto(this)">
            <h5 class="mt-3 fw-bold" id="sidebarUserName">INGENIERO</h5>
            <small class="text-warning d-block" id="sidebarCarrera">Carrera</small>
        </div>
        
        <hr class="opacity-25">
        <nav>
            <small class="text-muted text-uppercase fw-bold mb-3 d-block" style="font-size: 0.7rem;">Menú</small>
            <a href="#" class="nav-link-custom active" onclick="navegar('escuela')"><i class="fas fa-university me-2"></i> Dashboard</a>
            <a href="/editar.html" class="nav-link-custom"><i class="fas fa-edit me-2"></i> Gestionar Datos</a>
            <button onclick="cerrarSesion()" class="btn btn-outline-danger w-100 mt-5 rounded-pill btn-sm">Salir</button>
        </nav>
    </div>

    <div class="main-content">
        <div class="header-status d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1 fw-bold">Bienvenido, <span id="userName">...</span></h2>
                <p class="mb-0 opacity-75 fs-6" id="fechaHoy"></p>
            </div>
            <div class="text-end">
                <div class="reloj-box" id="relojHermosillo">00:00:00</div>
                <span class="badge bg-dark text-warning border border-warning px-3 rounded-pill mt-2">Hermosillo, Sonora</span>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4"><i class="fas fa-calendar-alt text-danger me-2"></i> Mi Agenda Académica</h5>
                    <div id="calendar"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="glass-card mb-4">
                    <h5 class="fw-bold mb-3 text-danger"><i class="fas fa-bolt me-2"></i> Pendientes Hoy</h5>
                    <hr class="border-secondary">
                    <div id="pendientesLista" class="small"></div>
                </div>
                <div class="glass-card text-center bg-dark text-white border-danger shadow">
                    <i class="fas fa-graduation-cap fa-3x mb-3 text-danger"></i>
                    <h6 id="displayCarrera" class="fw-bold">Cargando...</h6>
                    <small class="opacity-50">UES - 2026</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
        const userEmail = localStorage.getItem('userEmail');
        const userCarrera = localStorage.getItem('userCarrera');

        document.addEventListener('DOMContentLoaded', async () => {
            if(!userEmail) window.location.href = '/index.html';
            
            // Cargar Datos
            const name = userEmail.split('@')[0].toUpperCase();
            document.getElementById('userName').innerText = name;
            document.getElementById('sidebarUserName').innerText = name;
            document.getElementById('displayCarrera').innerText = userCarrera || "Ingeniería";
            document.getElementById('sidebarCarrera').innerText = userCarrera || "Ingeniería";
            
            // Cargar Foto guardada
            const savedPhoto = localStorage.getItem('userPhoto');
            if(savedPhoto) document.getElementById('userPhoto').src = savedPhoto;

            document.getElementById('fechaHoy').innerText = new Date().toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            setInterval(actualizarReloj, 1000);
            actualizarReloj();
            await inicializarCalendario();
        });

        function subirFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('userPhoto').src = e.target.result;
                    localStorage.setItem('userPhoto', e.target.result); // Persistencia local
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function actualizarReloj() {
            const opciones = { timeZone: 'America/Hermosillo', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('relojHermosillo').innerText = new Date().toLocaleTimeString('es-MX', opciones);
        }

        async function inicializarCalendario() {
            try {
                const res = await fetch(`/obtener-materias/${encodeURIComponent(userEmail)}`);
                const materias = await res.json();
                const events = [];
                const lista = document.getElementById('pendientesLista');
                const hoy = new Date().toLocaleDateString('sv-SE');
                lista.innerHTML = '';

                materias.forEach(m => {
                    m.tareas.forEach(t => {
                        events.push({ title: `${m.nombre}: ${t.descripcion}`, start: t.fecha, color: t.completada ? '#28a745' : '#800000' });
                        if(t.fecha === hoy && !t.completada) {
                            lista.innerHTML += `<div class="alert alert-danger border-0 py-2 mb-2 shadow-sm small d-flex justify-content-between"><span>${t.descripcion}</span><b class="ms-2">${m.nombre}</b></div>`;
                        }
                    });
                });

                if(lista.innerHTML === '') lista.innerHTML = '<p class="text-muted text-center">¡Día libre!</p>';
                new FullCalendar.Calendar(document.getElementById('calendar'), { initialView: 'dayGridMonth', locale: 'es', events: events, themeSystem: 'bootstrap5' }).render();
            } catch (e) { console.error("Error"); }
        }

        function navegar(opcion) { localStorage.setItem('perfilUsuario', opcion); window.location.href = '/dashboard.html'; }
        function cerrarSesion() { localStorage.clear(); window.location.href = '/index.html'; }
    </script>
</body>
</html>