<div id="paso1">
    <label>UNIVERSIDAD</label>
    <select id="uniInput" class="form-select mb-3" onchange="actualizarCarreras()">
        <option value="UES">UES - Estatal de Sonora</option>
        <option value="UNISON">UNISON - Univ. de Sonora</option>
        <option value="ITH">ITH - Tec. de Hermosillo</option>
    </select>
    <label>CARRERA</label>
    <select id="carreraInput" class="form-select mb-4">
        </select>
    <button onclick="validarYPasar()" class="btn btn-ues">Siguiente</button>
</div>

<div id="paso2" style="display:none;">
    <label id="infoCarreraSeleccionada" class="text-warning small mb-3"></label>
    <input type="email" id="emailInput" class="form-control mb-3" placeholder="Correo Institucional">
    <input type="password" id="passInput" class="form-control mb-3" placeholder="Contraseña">
    <button onclick="entrar()" class="btn btn-success w-100">ENTRAR AL SISTEMA</button>
</div>

<script>
    const oferta = {
        "UES": ["Ingeniería en Software", "Ingeniería Mecatrónica"],
        "UNISON": ["Lic. en Medicina", "Lic. en Derecho"],
        "ITH": ["Ingeniería Industrial", "Sistemas"]
    };

    function actualizarCarreras() {
        const uni = document.getElementById('uniInput').value;
        const select = document.getElementById('carreraInput');
        select.innerHTML = oferta[uni].map(c => `<option value="${c}">${c}</option>`).join('');
    }
    window.onload = actualizarCarreras;

    function validarYPasar() {
        const carrera = document.getElementById('carreraInput').value;
        if(!carrera) return alert("Selecciona una carrera");
        
        // Guardamos la carrera visualmente para confirmar
        document.getElementById('infoCarreraSeleccionada').innerText = "Carrera: " + carrera;
        document.getElementById('paso1').style.display = 'none';
        document.getElementById('paso2').style.display = 'block';
    }

    async function entrar() {
        const email = document.getElementById('emailInput').value;
        const codigo = document.getElementById('passInput').value;
        const carrera = document.getElementById('carreraInput').value; // Ahora sí lo encontrará
        const universidad = document.getElementById('uniInput').value;

        if(!email || !codigo) return alert("Llena todos los campos");

        const res = await fetch('/verificar-codigo', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, codigo, carrera, universidad })
        });
        
        const data = await res.json();
        if(res.ok) {
            localStorage.setItem('userEmail', email);
            window.location.href = data.redirect;
        } else {
            alert("Error de acceso");
        }
    }
</script>