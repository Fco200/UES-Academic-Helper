<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema Académico UES</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f4f4f4; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { border-top: 5px solid #800000; border-radius: 10px; width: 100%; max-width: 400px; }
        .btn-ues { background-color: #800000; color: white; }
        .btn-ues:hover { background-color: #600000; color: white; }
        
        /* Loader Overlay */
        #loader-container {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #800000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader-container">
        <div class="spinner"></div>
        <p class="mt-3 fw-bold" style="color: #800000;">Procesando solicitud...</p>
    </div>

    <div class="card login-card shadow p-4">
        <div class="text-center mb-4">
            <h2 style="color: #800000;">UES</h2>
            <p class="text-muted">Ingresa tu correo institucional</p>
        </div>

        <div id="paso1">
            <input type="email" id="email" class="form-control mb-3" placeholder="correo@gmail.com">
            <button onclick="enviarCodigo()" class="btn btn-ues w-100">Enviar Código</button>
        </div>

        <div id="paso2" style="display: none;" class="mt-3">
            <p class="text-success small text-center">Código enviado. Revisa tu correo.</p>
            <input type="text" id="codigo" class="form-control mb-3" placeholder="Ingresa el código de 6 dígitos">
            <button onclick="verificarCodigo()" class="btn btn-success w-100">Verificar e Ingresar</button>
        </div>
    </div>

    <script>
        const loader = document.getElementById('loader-container');

        async function enviarCodigo() {
            const email = document.getElementById('email').value;
            if (!email) return alert("Ingresa un correo");

            loader.style.display = 'flex';
            try {
                const res = await fetch('/enviar-codigo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (res.ok) {
                    localStorage.setItem('userEmail', email);
                    document.getElementById('paso1').style.display = 'none';
                    document.getElementById('paso2').style.display = 'block';
                } else {
                    alert("Error al enviar el código. Intenta de nuevo.");
                }
            } catch (e) {
                alert("Error de conexión con el servidor.");
            } finally {
                loader.style.display = 'none';
            }
        }

        async function verificarCodigo() {
            const email = localStorage.getItem('userEmail');
            const codigo = document.getElementById('codigo').value;

            loader.style.display = 'flex';
            try {
                const res = await fetch('/verificar-codigo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, codigo })
                });

                const data = await res.json();
                if (res.ok) {
                    window.location.href = data.redirect; // Te manda a home.html
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert("Error al verificar.");
            } finally {
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>