<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguridad | UES Helper</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --ues-guinda: #800000; --sidebar-w: 280px; }
        body { background: #f4f7f6; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* Sidebar (Igual al de tus otras páginas para consistencia) */
        .sidebar { width: var(--sidebar-w); background: white; border-right: 1px solid #ddd; height: 100vh; position: fixed; padding: 30px 20px; }
        .main-content { margin-left: var(--sidebar-w); padding: 50px; display: flex; justify-content: center; }
        
        .nav-btn { width: 100%; padding: 15px; border-radius: 12px; display: flex; align-items: center; color: #555; text-decoration: none; transition: 0.3s; margin-bottom: 8px; font-weight: 600; }
        .nav-btn:hover { background: #f0f0f0; color: var(--ues-guinda); }
        .nav-btn.active { background: var(--ues-guinda); color: white; }

        /* Tarjeta de Seguridad */
        .security-card { 
            background: white; 
            border-radius: 30px; 
            padding: 40px; 
            width: 100%; 
            max-width: 500px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .form-control { 
            background: #f9f9f9 !important; 
            border: 1px solid #eee !important; 
            border-radius: 12px; 
            padding: 12px; 
            margin-bottom: 20px;
        }

        .shield-icon {
            font-size: 3rem;
            color: var(--ues-guinda);
            margin-bottom: 20px;
            display: block;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h4 class="fw-bold mb-5 text-dark">UES <span class="text-danger">HELPER</span></h4>
        <nav>
            <a href="/home.html" class="nav-btn"><i class="fas fa-home me-3"></i> Inicio</a>
            <a href="/dashboard.html" class="nav-btn"><i class="fas fa-tasks me-3"></i> Tareas</a>
            <a href="/perfil.html" class="nav-btn"><i class="fas fa-user-circle me-3"></i> Mi Perfil</a>
            <a href="/seguridad.html" class="nav-btn active"><i class="fas fa-shield-alt me-3"></i> Seguridad</a>
            <button onclick="cerrarSesion()" class="btn btn-outline-danger w-100 rounded-pill py-2 mt-5 fw-bold">SALIR</button>
        </nav>
    </div>

    <div class="main-content">
        <div class="security-card text-center">
            <i class="fas fa-user-shield shield-icon"></i>
            <h3 class="fw-bold mb-2">Contraseña</h3>
            <p class="text-muted mb-4 small">Cambia tu llave de acceso para mantener tu cuenta segura.</p>

            <div class="text-start">
                <label class="small fw-bold text-muted mb-2">CONTRASEÑA ACTUAL</label>
                <input type="password" id="passActual" class="form-control" placeholder="••••••••">

                <label class="small fw-bold text-muted mb-2">NUEVA CONTRASEÑA</label>
                <input type="password" id="nuevaPass" class="form-control" placeholder="Mínimo 6 caracteres">

                <label class="small fw-bold text-muted mb-2">CONFIRMAR NUEVA CONTRASEÑA</label>
                <input type="password" id="confirmaPass" class="form-control" placeholder="••••••••">
            </div>

            <button onclick="actualizarPassword()" class="btn btn-danger w-100 py-3 rounded-4 fw-bold mt-3 shadow-sm">
                ACTUALIZAR SEGURIDAD
            </button>
            
            <div class="mt-4 p-3 bg-light rounded-4">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i> 
                    Al cambiar tu contraseña, se te enviará un correo de confirmación.
                </small>
            </div>
        </div>
    </div>

    <script>
        const userEmail = localStorage.getItem('userEmail');

        async function actualizarPassword() {
        // Asegurarnos de que el email no tenga espacios ni comillas
    const userEmail = localStorage.getItem('userEmail').replace(/['"]+/g, '').trim(); 
    const pa = document.getElementById('passActual').value.trim();
    const np = document.getElementById('nuevaPass').value.trim();
    const cp = document.getElementById('confirmaPass').value.trim();

            if(!pa || !np || !cp) return alert("⚠️ Completa todos los campos.");
            if(np !== cp) return alert("❌ Las nuevas contraseñas no coinciden.");
            if(np.length < 6) return alert("⚠️ La nueva clave debe tener al menos 6 caracteres.");

           const res = await fetch('/actualizar-seguridad', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
            email: userEmail, 
            passActual: pa, 
            nuevaPass: np 
        })
    })

            if(res.ok) {
                alert("✅ ¡Contraseña actualizada! Revisa tu correo.");
                window.location.href = '/perfil.html';
            } else {
                const err = await res.json();
                alert("❌ " + (err.message || "Error al actualizar"));
            }
        }

        function cerrarSesion() { localStorage.clear(); window.location.href = '/index.html'; }
    </script>
</body>
</html>