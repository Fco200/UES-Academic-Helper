<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Seguridad | UES Helper</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --ues-guinda: #800000; --bg: #f8f9fa; }
        body { background: var(--bg); color: #333; font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #ddd; height: 100vh; position: fixed; padding: 30px; }
        .main-content { margin-left: 280px; padding: 60px; display: flex; justify-content: center; }
        
        .security-card { background: white; border-radius: 30px; padding: 45px; width: 100%; max-width: 550px; border: 1px solid #eee; box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
        .form-control { background: #fdfdfd !important; border: 1px solid #ddd !important; color: #111 !important; border-radius: 12px; padding: 14px; }
        .nav-link-custom { color: #555; padding: 12px; border-radius: 12px; display: block; text-decoration: none; margin-bottom: 10px; font-weight: 600; }
        .nav-link-custom.active { background: var(--ues-guinda); color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h4 class="fw-bold mb-5 text-dark">UES <span class="text-danger">HELPER</span></h4>
        <nav>
            <a href="/home.html" class="nav-link-custom"><i class="fas fa-home me-2"></i> Inicio</a>
            <a href="/dashboard.html" class="nav-link-custom"><i class="fas fa-tasks me-2"></i> Tareas</a>
            <a href="/perfil.html" class="nav-link-custom"><i class="fas fa-user-circle me-2"></i> Mi Perfil</a>
            <a href="/seguridad.html" class="nav-link-custom active"><i class="fas fa-shield-alt me-2 text-danger"></i> Seguridad</a>
            <a href="/soporte.html" class="nav-link-custom"><i class="fas fa-headset me-2"></i> Soporte</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="security-card">
            <h3 class="fw-bold text-dark mb-4"><i class="fas fa-lock text-danger me-2"></i> Seguridad de la Cuenta</h3>
            <div class="bg-light p-3 rounded-4 mb-4 border-start border-4 border-warning">
                <small class="text-muted fw-bold">ÚLTIMO ACCESO</small>
                <p class="m-0 text-dark" id="displayUltimoAcceso">Cargando...</p>
            </div>
            
            <div class="mb-3"><label class="small fw-bold mb-2">CONTRASEÑA ACTUAL</label><input type="password" id="passActual" class="form-control"></div>
            <hr class="my-4">
            <div class="mb-3"><label class="small fw-bold mb-2">NUEVA CONTRASEÑA</label><input type="password" id="nuevaPass" class="form-control" placeholder="Mínimo 6 caracteres"></div>
            <div class="mb-4"><label class="small fw-bold mb-2">CONFIRMAR NUEVA</label><input type="password" id="confirmaPass" class="form-control"></div>
            
            <button onclick="actualizarCredenciales()" class="btn btn-danger w-100 py-3 fw-bold rounded-4 shadow">GUARDAR CAMBIOS</button>
        </div>
    </div>

    <script>
        const userEmail = localStorage.getItem('userEmail');
        window.onload = async () => {
            const res = await fetch(`/obtener-usuario/${encodeURIComponent(userEmail)}`);
            const u = await res.json();
            document.getElementById('displayUltimoAcceso').innerText = u.ultimoAcceso || "Primera sesión";
        };

        async function actualizarCredenciales() {
            const pa = document.getElementById('passActual').value, np = document.getElementById('nuevaPass').value, cp = document.getElementById('confirmaPass').value;
            if(np !== cp) return alert("No coinciden.");
            const res = await fetch('/actualizar-seguridad', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, passActual: pa, nuevaPass: np }) });
            if(res.ok) { alert("Actualizado con éxito."); localStorage.clear(); window.location.href='/index.html'; }
        }

        function cerrarSesion() { localStorage.clear(); window.location.href = '/index.html'; }
    </script>
</body>
</html>